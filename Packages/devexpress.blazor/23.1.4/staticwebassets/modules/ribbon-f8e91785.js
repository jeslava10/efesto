import{d as t}from"./dom-f93f7533.js";import{H as e,o as s,I as i,K as o,k as n,R as l,f as r,u as h}from"./dom-utils-04e3c6d2.js";import{d as a}from"./disposable-d2c2d283.js";import{U as u}from"./ribbon-utils-1f8753d1.js";import{initFocusHidingEvents as c}from"./focus-utils-cd9c9bc2.js";import{T as d}from"./toolbar-css-classes-98be7512.js";import{C as p}from"./css-classes-f3f8ed66.js";import"./_tslib-6e8ca86b.js";import"./touch-b17c92da.js";class g{constructor(t){this.container=null,this.owner=t}querySelectorAll(t){var e;return this.querySelectorAllInternal(t||"#"+(null===(e=this.getContainer())||void 0===e?void 0:e.id))}toggleClassName(t,e,s){return this.owner?this.owner.toggleClassName(t,e,s):this.toggleClassNameInternal(t,e,s)}toggleClassNameInternal(t,e,s){}querySelectorAllInternal(t){return this.owner?this.owner.querySelectorAll(t):this.getNodes(t)}getNodes(t){const e=this.container;let s=e.querySelectorAll(t);return s.length||(t="#"+e.id+t,e.parentNode&&(s=e.parentNode.querySelectorAll(t))),s}getContainer(){return this.owner?this.owner.getContainer():this.container}getBoxSize(t){return Math.ceil(e(t))+this.getBoxOuterOffset(t)}getBoxInnerOffset(t){return s(t)}getBoxOuterOffset(t){return i(t)}getBoxOffset(t){return this.getBoxOuterOffset(t)+this.getBoxInnerOffset(t)}getNodeWidth(t,e=!1){const s=t;return s?Math.ceil(s.offsetWidth+(e?0:this.getBoxOuterOffset(s)))+o(s):0}dispose(){}setActive(t){}createLayoutEntity(t,...e){return null!==this.owner?this.owner.createLayoutEntity(t,...e):this.createLayoutEntityCore(t,...e)}createLayoutEntityCore(t,...e){return new(this.resolveLayoutEntityType(t))(...e)}resolveLayoutEntityType(t){return t}}const f=`.${d.ButtonToolbar}`,m=`.${d.ButtonEllipsis}`,y="data-dx-ribbon-toolbar-loaded";class k extends g{constructor(t,e,s){super(t),this.nextBlock=null,this.prevBlock=null,this.ribbonOwner=t,this.group=e,this.element=s,this.width=0,this.isActiveValue=null,this.index=e.blocks.length,this.nextBlock=null,this.prevBlock=s.layoutBlockObj||null,this._element=s,this._element.layoutBlockObj=this._element.layoutBlockObj?this._element.layoutBlockObj.nextBlock=this:this,this._element.onHide=()=>{this.toggleClassName(this.element,d.ToolbarHiddenItem,!0)},this._element.onShow=()=>{this.toggleClassName(this.element,d.ToolbarHiddenItem,!1)}}dispose(){delete this._element.onHide,delete this._element.onShow,this.ribbonOwner=null,super.dispose()}afterCreate(t){delete this._element.layoutBlockObj,t.maxWidth+=this.width,t.minWidth+=this.getMinWidth(),0===this.width&&this.raiseVisibilityChange(!1)}setActive(t){this.isActiveValue!==t&&(this.isActiveValue=t,this.group.activeBlock=t?this:null,this.group.groupsCollection.lastGroup=this.group,this.group.state.prevState&&this.toggleClassName(this.group.element.parentNode,this.group.state.prevState.name,this.isActiveValue),this.toggleClassName(this.element,this.group.state.name,this.isActiveValue),this.toggleClassName(this.group.element,this.group.state.name,this.isActiveValue))}raiseVisibilityChange(t){var e,s;const i=t?this._element.onShow:this._element.onHide;i&&(null===(e=this.owner)||void 0===e||e.domChanges.push(i)),null===(s=this.ribbonOwner)||void 0===s||s.toggleVisibility(this.element,t)}getMinWidth(){return this.nextBlock?this.nextBlock.getMinWidth():this.width}getNextBlock(t){let e=this.group,s=e.blocks[this.index-t];return!s&&(e=e.groupsCollection.blockGroups[e.totalIndex+t])&&(s=e.blocks[Math.pow(e.blocks.length,t>0?1:0)-1]),s}}class B extends g{constructor(t,e,s,i){super(t),this.builders=e||[],this.name=s,this.index=i?i.index+1:0,this.prevState=i,this.nextState=null,i&&(i.nextState=this)}for(t){return this.builders[this.builders.length]=this.createLayoutEntity(x,this.owner,this.name,t)}}class b extends g{constructor(t,e,s,i,o){super(t),this.groupsCollection=e,this.state=i,this.element=s,this.elementOffset=this.getBoxOffset(s)+this.getBeforeOffset(s),this.blocks=[],this.activeBlock=null,this.fullWidth=this.elementOffset,this.isSmallest=!i.nextState,this.isLargest=!i.prevState,this.domIndex=o,this.totalIndex=this.groupsCollection.blockGroups.length,this.createBlocks(i.builders);const n=s;i.prevState&&(this.isSmallest||(n.layoutBlockGroupObj.isSmallest=0===this.blocks.length))?delete n.layoutBlockGroupObj:n.layoutBlockGroupObj=this}dispose(){for(let t=0;t<this.blocks.length;t++)this.blocks[t].dispose();super.dispose()}afterCreate(t){this.blocks.forEach((function(e){e.afterCreate(t)})),t.groupsOffset+=this.elementOffset,t.groupBlocksLengthLookup[this.domIndex]=this.blocks.length,t.lastGroup=this}setActive(t){let e=0;!this.isSmallest&&this.isLargest&&(e=this.blocks.length-1),this.blocks[e].setActive(t)}createBlocks(t){for(let e=0;e<t.length;e++){const s=t[e],i=s.findBlockElements(this.element);for(let t=0;t<i.length;t++){const e=this.createLayoutEntity(k,this.owner,this,i[t]);this.fullWidth+=e.width=s.getBlockWidth(e),this.blocks.push(e)}}this.isLargest&&this.setActive(!0)}calculateWidth(t){return this!==t.group?this.fullWidth:this.getActualBlocks(t).reduce((function(t,e){return t+e.width}),this.elementOffset)}getActualBlocks(t){return this.blocks.map(function(e){return e.prevBlock&&e.index<t.index?e.prevBlock:e}.bind(this))}getBeforeOffset(e){const s=window.getComputedStyle(e,":before");return t.DomUtils.pxToInt(s.width)+t.DomUtils.pxToInt(s.marginRight)}}class C extends g{constructor(t,e,s){super(t),this.ribbonOwner=t,this.groupsContainer=e,this.testElement="function"==typeof s?s:function(t){return u.elementMatchesSelector(t,s)},this.blockGroups=[],this.states=[],this.width=0,this.groupsOffset=0,this.maxWidth=0,this.minWidth=0,this.groupElementsCount=0,this.currentLayoutElements=[],this.lastGroup=null,this.selector=s,this.groupLookupMap={},this.groupBlocksLengthLookup={}}createBlockGroup(t,e,s){let i=this.createLayoutEntity(b,this.owner,this,t,e,s);return i&&(i=i.blocks.length>0?this.blockGroups[this.blockGroups.length]=i:null),i&&(this.groupLookupMap[s]||(this.groupLookupMap[s]=[])).splice(0,0,i.totalIndex),i}createBlockGroups(){var t;const e=null===(t=this.ribbonOwner)||void 0===t?void 0:t.getGroupElements(this.groupsContainer,this.selector);if(e){this.groupElementsCount=e.length;for(let t=0;t<this.states.length;t++)for(let s=this.groupElementsCount-1;s>=0;s--){const i=e[s];!i||this.testElement(i)&&this.createBlockGroup(i,this.states[t],s)||(e[s]=null)}this.states=[];for(let t=0;t<this.blockGroups.length&&this.blockGroups[t].isLargest;t++)this.blockGroups[t].afterCreate(this);this.minWidth+=this.groupsOffset,this.maxWidth+=this.groupsOffset,this.width=this.maxWidth,this.currentLayoutElements=this.findActiveBlocks()}}defineState(t,e){const s=this.createLayoutEntity(B,this.owner,[],t,this.states[this.states.length-1]||null);this.states.push(s),e(s)}initialize(){}applyLayout(t){this.currentLayoutElements&&this.currentLayoutElements.forEach((function(t){t.setActive(!1)})),this.currentLayoutElements=t,this.currentLayoutElements.forEach((function(t){t.setActive(!0)})),this.detectBlockItemVisibilityChanges()}adjust(t){if(t===this.width||t<=this.minWidth&&this.width===this.minWidth||t>=this.maxWidth&&this.width===this.maxWidth)return;const e=this.width;if(this.width=Math.max(this.minWidth,Math.min(this.maxWidth,t)),this.width===this.maxWidth)return this.applyLayout(this.blockGroups.filter((function(t){return t.isLargest})));if(this.width===this.minWidth)return this.applyLayout(this.blockGroups.filter((function(t){return t.isSmallest})));const s=e-this.width,i=s/Math.abs(s),o=this.findActiveBlocks();let n=o?o[0]:null,l=n;const r=n;for(;n;){if(t=this.calculateWidth(n),i>0&&t<=this.width||i<0&&t>=this.width){const t=i<0?l:n;t!==r&&null!==t&&this.applyLayout([t]);break}l=n,n=n.getNextBlock(i)}}detectBlockItemVisibilityChanges(){const t=this.findActualBlockGroups();for(let e=0;e<t.length;e++){const s=t[e];let i=!1;for(let t=0;t<s.blocks.length;t++){let e=s.blocks[t];s!==this.lastGroup||(i=i||e.isActiveValue)||(e=e.prevBlock||e),e.raiseVisibilityChange(e.width>0)}}}calculateWidth(t){if(!t){const e=this.findActiveBlocks();e&&(t=e[0])}return this.findActualBlockGroups(t.group).reduce((function(e,s){return e+s.calculateWidth(t)}),0)}findActualBlockGroups(t=null){const e=[];if(!(t=t||this.lastGroup))return e;for(let s=0;s<this.groupElementsCount;s++){const i=this.groupLookupMap[s];for(let o=0;o<i.length;o++){const n=this.blockGroups[i[o]];if(s<t.domIndex?n.state.index<t.state.index:n.state.index<=t.state.index){e.push(n);break}}}return e}findActiveBlocks(){return this.lastGroup?this.lastGroup.blocks.filter((function(t){return t.isActiveValue})):null}dispose(){for(let t=0;t<this.blockGroups.length;t++)this.blockGroups[t].dispose();this.blockGroups=[],super.dispose()}}class x extends g{constructor(t,e,s){super(t),this.name=e,this.selectorOrFunc=s,this.prepareBlockFunc=null}getBlockWidth(t){return this.prepareBlockFunc?this.prepareBlockFunc(t):0}findBlockElements(t){const e=u.getChildElementNodesByPredicate(t,(t=>u.elementMatchesSelector(t,this.selectorOrFunc)));return null!=e?e:[]}setPrepareFunc(t){return this.prepareBlockFunc=t,this}setWidth(){return this.setPrepareFunc((t=>this.getBoxSize(t.element)))}setHidden(){return this.setPrepareFunc((function(t){return 0}))}setOnlyImageWidth(){return this.setPrepareFunc((t=>{let e=this.getBoxSize(t.element),s=u.getChildByClassName(t.element,`${p.Image}:not(.${d.AdaptivePreviewImage})`);s||(s=u.getChildByClassName(u.getChildByClassName(t.element,d.DropDownToggle),`${p.Image}:not(.${d.AdaptivePreviewImage})`));let i=u.getChildByClassName(t.element,d.AdaptivePreviewImage);if(i||(i=u.getChildByClassName(u.getChildByClassName(t.element,d.DropDownToggle),d.AdaptivePreviewImage)),s){if(e=this.getBoxSize(s)-this.getBoxOuterOffset(s),i){const t=this.getBoxSize(i)-this.getBoxOuterOffset(i);e=Math.max(e,t)}let o=this.getBoxOffset(t.element),n=s.parentNode;for(;n!==t.element;)o+=this.getBoxOffset(n),n=n.parentNode;return e+o}return e}))}setNoTextWidth(){return this.setPrepareFunc((t=>{let e=this.getBoxSize(t.element);if(u.getChildByClassName(t.element,d.ToolbarEdit))return e;let s=u.getChildByClassName(t.element,p.Image);if(s||(s=u.getChildByClassName(u.getChildByClassName(t.element,p.Button),p.Image)),s){const t=s.nextElementSibling;t&&(e-=this.getBoxSize(t),e-=this.getBoxOuterOffset(s))}return e}))}}class v extends g{constructor(t){super(null),this.clientStateMap=new Map,this.dotNetReference=t.dotNetReference,this.container=t.getMainElement(),this.containerOffsets=this.calculateContainerOffsets(),this.blockGroupsArray=[],this.isReady=!1,this.classesToApply=[],this.domChanges=[],this.nextAdjustGroupWidth=null}getClientState(t){const e=t.dataset.dxtoolbarItemId;if(!e)return null;let s=this.clientStateMap.get(e);return s||(s={id:e},this.clientStateMap.set(e,s)),s}toggleClassNameInternal(t,e,s){this.getBatchCssUpdateCache(t)[e]=s;const i=this.getClientState(t);i&&(i[e]=s)}getBatchCssUpdateCache(t){let e=t._layoutBuilderCache;return e||(e=t._layoutBuilderCache={},this.classesToApply.push(this.createBatchCssUpdateDelegate(t))),e}createBatchCssUpdateDelegate(e){return function(){const s=e._layoutBuilderCache;if(s){delete e._layoutBuilderCache;for(const i in s)Object.prototype.hasOwnProperty.call(s,i)&&t.DomUtils.toggleClassName(e,i,s[i])}}}createBlockGroupsCore(t,e,s){const i=[],o=this.querySelectorAll(t);for(let t=0;t<o.length;t++){const n=this.createLayoutEntity(C,this,o[t],e);this.blockGroupsArray.push(n),s&&s(n),n.createBlockGroups(),i.push(n)}return this.nextAdjustGroupWidth=this.getGroupsWidth(),i}initialize(){for(let t=0;t<this.blockGroupsArray.length;t++)this.blockGroupsArray[t].initialize();this.isReady=!0,this.adjust()}adjust(t=null){if(this.isReady){const e=this.classesToApply,s=this.domChanges;let i=this.classesToApply=[],o=this.domChanges=[];const l=this.clientStateMap;let r;null!==this.nextAdjustGroupWidth?(r=this.nextAdjustGroupWidth,this.nextAdjustGroupWidth=null):r=this.getGroupsWidth();for(let t=0;t<this.blockGroupsArray.length;t++)this.blockGroupsArray[t].adjust(r);t&&t(),i=e.concat(i),o=s.concat(o);const h=Array.from(l.values()).concat(Array.from(this.clientStateMap.values()));this.queueUpdates((()=>{for(;i.length;){const t=i.shift();t&&t()}this.queueUpdates((()=>{for(;o.length;){const t=o.shift();t&&t()}h.length&&this.dotNetReference.invokeMethodAsync("OnModelUpdated",h).catch((t=>{n(this.container)||console.error(t)}))}))}))}}toggleVisibility(t,e){const s=this.getClientState(t);s&&(s.isVisible=e)}queueUpdates(t){l(t)}getGroupsWidth(){const t=this.getContainer();return t?t.offsetWidth-this.containerOffsets:0}dispose(){this.containerOffsets=this.calculateContainerOffsets();for(let t=0;t<this.blockGroupsArray.length;t++)this.blockGroupsArray[t].dispose();this.blockGroupsArray=[],this.classesToApply=[],this.isReady=!1,super.dispose()}getGroupElements(t,e){return u.getChildElementNodesByPredicate(t,(function(t){return u.elementMatchesSelector(t,e)}))}createBlockGroups(){this.createBlockGroupsCore(`.${d.Toolbar} > ${f}`,`.${d.ToolbarGroup}`,(function(t){t.defineState(d.AdaptiveItem,(function(t){t.for(`:not(${m})`).setWidth(),t.for(m).setHidden()})),t.defineState(d.AdaptiveItemTextHidden,(function(t){t.for(`:not(${m})`).setNoTextWidth(),t.for(m).setHidden()})),t.defineState(d.AdaptiveItemHidden,(function(t){t.for(`:only-child:not(${m})`).setWidth(),t.for(`:not(:only-child):not(${m})`).setHidden(),t.for(m).setWidth()})),t.defineState(d.AdaptiveItemAllHidden,(function(t){t.for(`:only-child:not(${m})`).setNoTextWidth(),t.for(`:not(:only-child):not(${m})`).setHidden(),t.for(m).setNoTextWidth()}))}))}calculateContainerOffsets(){var t;if(!this.container)return 0;let e=this.getBoxInnerOffset(this.container),s=null!==(t=this.container.querySelector(".dxbl-toolbar"))&&void 0!==t?t:this.container;for(;s!==this.container&&s;)e+=this.getBoxOffset(s),s=s.parentNode;return e}}class A{constructor(t,e){this.currentWidth=null,this.currentHeight=null,this.elementContentWidthSubscription=null,this.mainElement=t,this.layoutBreakPoints=null,this.dotNetReference=e}getMainElement(){return this.mainElement}initialize(){l((()=>{this.buildLayout()})),l((()=>{this.adjustLayout()})),this.elementContentWidthSubscription=r(this.getMainElement(),(t=>{this.currentWidth===t.width&&this.currentHeight===t.height||(this.currentWidth=t.width,this.currentHeight=t.height,this.onBrowserWindowResize())}))}applyLayoutStateAppearance(){var e;t.DomUtils.addClassName(this.getMainElement(),d.Loaded),null===(e=this.layoutBreakPoints)||void 0===e||e.initialize(),setTimeout((()=>{t.DomUtils.removeClassName(this.getMainElement(),d.Loading)}),500)}onBrowserWindowResize(){this.layoutBreakPoints&&this.layoutBreakPoints.adjust()}update(){this.layoutBreakPoints&&this.layoutBreakPoints.adjust()}dispose(){this.elementContentWidthSubscription&&h(this.elementContentWidthSubscription),this.layoutBreakPoints&&this.layoutBreakPoints.dispose()}buildLayout(){this.layoutBreakPoints=this.layoutBreakPoints||new v(this),this.layoutBreakPoints.createBlockGroups()}adjustLayout(){var t;this.applyLayoutStateAppearance(),null===(t=this.layoutBreakPoints)||void 0===t||t.adjust()}}const w=new Map;function O(t,e,s){if(!t)return Promise.reject("failed");let i=w.get(t);i?i.update():(i=new A(t,s),i.initialize(),w.set(t,i));const o=t.querySelector(f)||t;return c(o),l((()=>{t.setAttribute(y,"")})),Promise.resolve("ok")}function S(t){return e(t,w),Array.from(w.keys()).forEach((t=>{n(t)&&e(t,w)})),Promise.resolve("ok");function e(t,e){if(!t)return;const s=t.querySelector(f);s&&a(s);const i=e.get(t);null==i||i.dispose(),e.delete(t)}}const W={init:O,dispose:S};export{W as default,S as dispose,O as init};
